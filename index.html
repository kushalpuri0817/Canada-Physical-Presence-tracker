<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Physical Presence Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-xl p-8 border-t-4 border-blue-500">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Canada Physical Presence Tracker</h1>
            <p class="text-sm text-gray-500">Enter trips for each person to calculate their days of presence for citizenship.</p>
        </div>

        <!-- User ID display -->
        <div id="userIdDisplay" class="text-center text-sm text-gray-600 mb-4 bg-gray-100 p-2 rounded-lg">
            <span class="font-semibold">Your User ID:</span> <span id="currentUserId" class="font-mono">Loading...</span>
        </div>

        <!-- Person Selection and Input Section -->
        <div class="mb-6 bg-gray-50 p-6 rounded-lg">
            <label for="personSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Person</label>
            <select id="personSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out mb-4">
                <option value="Kushal">Kushal</option>
                <option value="Anjali">Anjali</option>
                <option value="Tanvi">Tanvi</option>
                <option value="Maira">Maira</option>
            </select>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="entryDate" class="block text-sm font-medium text-gray-700 mb-1">Entry Date</label>
                    <input type="date" id="entryDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="exitDate" class="block text-sm font-medium text-gray-700 mb-1">Exit Date</label>
                    <input type="date" id="exitDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>
            <button id="addTripBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Add Trip
            </button>
        </div>

        <!-- Trip List & Summary -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                Trip History for <span id="currentPerson" class="text-blue-600">Kushal</span>
            </h2>
            <div id="tripList" class="space-y-4">
                <!-- Trips will be added here -->
            </div>
            <div id="noTripsMessage" class="text-gray-500 text-center mt-4 hidden">No trips added yet.</div>
        </div>

        <!-- Total Days Summary -->
        <div class="mt-8 pt-4 border-t-2 border-gray-200">
            <div class="flex justify-between items-center bg-blue-50 p-4 rounded-lg">
                <span class="text-lg font-bold text-gray-800">Total Days of Presence:</span>
                <span id="totalDays" class="text-2xl font-extrabold text-blue-600">0</span>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">
                This calculation counts the day of entry and the day of exit as days of physical presence.
            </p>
        </div>

        <!-- Warning/Info Modal -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    </div>
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="modal-message"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="modal-close-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Got it!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
       // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    //    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
      //  const initialAuthToken = null;

       
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBN8xYYQ2d90po7W-3IizsR6WFf6tn5StM",
    authDomain: "canada-tracker.firebaseapp.com",
    projectId: "canada-tracker",
    storageBucket: "canada-tracker.firebasestorage.app",
    messagingSenderId: "898976695894",
    appId: "1:898976695894:web:e47fdf8eb58dbdd8f75df7",
    measurementId: "G-NHTH60F5JK"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // UI elements
        const entryDateInput = document.getElementById('entryDate');
        const exitDateInput = document.getElementById('exitDate');
        const addTripBtn = document.getElementById('addTripBtn');
        const tripList = document.getElementById('tripList');
        const totalDaysSpan = document.getElementById('totalDays');
        const noTripsMessage = document.getElementById('noTripsMessage');
        const personSelect = document.getElementById('personSelect');
        const currentPersonSpan = document.getElementById('currentPerson');
        const currentUserIdSpan = document.getElementById('currentUserId');

        // Modal elements
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let userId = null;

        // Helper function to show the custom modal
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        // Close modal event listener
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Function to render trips from a given array
        function renderTrips(trips) {
            tripList.innerHTML = '';
            if (trips.length === 0) {
                noTripsMessage.classList.remove('hidden');
            } else {
                noTripsMessage.classList.add('hidden');
                trips.forEach(trip => {
                    const tripElement = document.createElement('div');
                    tripElement.id = `trip-${trip.id}`;
                    tripElement.className = 'flex items-center justify-between p-4 bg-gray-100 rounded-md';
                    tripElement.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-900">${trip.entryDate} to ${trip.exitDate}</p>
                            <p class="text-sm text-gray-500">${trip.days} days</p>
                        </div>
                        <button class="remove-trip-btn bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 transition duration-150 ease-in-out" data-id="${trip.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    tripList.appendChild(tripElement);
                });

                // Add event listeners for remove buttons
                document.querySelectorAll('.remove-trip-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const tripId = e.currentTarget.dataset.id;
                        if (userId && tripId) {
                            // Delete the document from Firestore
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/trips`, tripId));
                            } catch (error) {
                                showModal('Error', 'Failed to delete trip. Please try again.');
                                console.error('Error removing document: ', error);
                            }
                        }
                    });
                });
            }
            updateTotal(trips);
        }

        // Function to update the total days
        function updateTotal(trips) {
            const totalDays = trips.reduce((sum, trip) => sum + trip.days, 0);
            totalDaysSpan.textContent = totalDays;
        }

        // Event listener for the "Add Trip" button
        addTripBtn.addEventListener('click', async () => {
            if (!userId) {
                showModal('Not Authenticated', 'Please wait for authentication to complete.');
                return;
            }

            const entryDate = entryDateInput.value;
            const exitDate = exitDateInput.value;
            const selectedPerson = personSelect.value;

            if (!entryDate || !exitDate) {
                showModal('Missing Dates', 'Please enter both an entry and an exit date.');
                return;
            }

            // Convert to Date objects for comparison
            const entry = new Date(entryDate);
            const exit = new Date(exitDate);

            if (entry > exit) {
                showModal('Invalid Dates', 'The entry date cannot be after the exit date.');
                return;
            }

            // Calculate the number of days, inclusive of both dates
            const diffTime = Math.abs(exit - entry);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            const newTrip = {
                entryDate: entryDate,
                exitDate: exitDate,
                days: diffDays,
                person: selectedPerson,
                createdAt: new Date()
            };

            // Add the new trip to Firestore
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/trips`), newTrip);
            } catch (error) {
                showModal('Error', 'Failed to add trip. Please try again.');
                console.error('Error adding document: ', error);
            }

            // Clear input fields
            entryDateInput.value = '';
            exitDateInput.value = '';
        });

        // Event listener for person selection change
        personSelect.addEventListener('change', () => {
            const selectedPerson = personSelect.value;
            currentPersonSpan.textContent = selectedPerson;
        });

        // Set up authentication and Firestore listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                currentUserIdSpan.textContent = userId;

                // Set up real-time listener for trips
                const tripsCollection = collection(db, `artifacts/${appId}/users/${userId}/trips`);
                const q = query(tripsCollection, where("person", "==", personSelect.value));

                onSnapshot(q, (querySnapshot) => {
                    const trips = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        trips.push({
                            id: doc.id,
                            entryDate: data.entryDate,
                            exitDate: data.exitDate,
                            days: data.days,
                            person: data.person
                        });
                    });
                    renderTrips(trips);
                }, (error) => {
                    console.error("Error fetching documents: ", error);
                    showModal('Error', 'Failed to load trip data. Please check your connection.');
                });
            } else {
                // If not logged in, try to sign in
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error('Custom token sign-in failed: ', error);
                        showModal('Authentication Error', 'Failed to sign in with custom token.');
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error('Anonymous sign-in failed: ', error);
                        showModal('Authentication Error', 'Failed to sign in anonymously.');
                    }
                }
            }
        });
    </script>
</body>
</html>
